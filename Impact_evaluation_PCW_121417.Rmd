---
title: "Preliminary results of the impact evaluation paper"
author: "Mani Rouhi Rad"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
#output: pdf_document
#output: md_document
output: 
  html_document:
    css: custom.css
#    keep_md: true
#fontsize: 12pt
---


```{r, include=FALSE, warning=FALSE}
library(rgeos)
library(rgdal)
library(plyr)
library(reshape2)
library(dplyr)
library(data.table)
library(ggplot2)
library(scales)
library(R.matlab)
library(sp)
library(sf)
library(maptools)
library(broom)
library(quantreg)
library(foreign)
library(raster)
library(lmtest)
library(RColorBrewer)
library(readstata13)
library(parallel)
library(stargazer)
library(AER)
library(texreg)
library(gridExtra)
library(grid)
library(directlabels)


```


```{r setup, include=FALSE}
# knitr::opts_knit$set(root.dir = 'C:/Users/mr2284/Dropbox/Panama S2/Impact Evaluation')
knitr::opts_knit$set(root.dir = 'C:/Users/mr2284/Dropbox/Research/Panama Canal-My material/Codes/IE/IE_PCW')
# knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='./Figures and Tables', echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE)
```


```{r, include=FALSE, warning=FALSE}
simpleCap <- function(x) {                                          # 1) Function defined to make all caps to propper
  paste(substring(x, 1,1), tolower(substring(x, 2)),                # 2)
        sep="")                       }                             # 3)

FN_area_sp = function(input_sp, scenario){                          # 1) function defined to find the area
  foo = st_as_sf(input_sp)
  a = as.data.table(input_sp@data)
  b = as.data.table(st_area(foo))
  b[, paste(scenario, "ha", sep="_"):=as.numeric(x*0.0001)]
  b=b[, 2]
  output_data=data.table(a, b)
  return(output_data)
}

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

grid_arrange_shared_legend <- function(...) {
  plots <- list(...)
  g <- ggplotGrob(plots[[1]] + theme(legend.position="bottom"))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  grid.arrange(
    do.call(arrangeGrob, lapply(plots, function(x)
      x + theme(legend.position="none"))),
    legend,
    ncol = 1,
    heights = unit.c(unit(1, "npc") - lheight, lheight))
    # heights=unit(c(2, 2, 2), c("in", "in", "in")))

}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
########                                  Input data    ######
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#                   I. River discharge
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# river_discharge=data.table(read.csv("./Data/Map Area_update.csv"))
river_discharge=data.table(read.csv("./Data/Map Area2.csv"))
river_discharge=melt(river_discharge, id=c("River", "Year", "Day"), variable.name = "month", value.name = "discharge_m3_s")
river_discharge=river_discharge[complete.cases(Day)]
river_discharge[ , month:=as.character(month)]
river_discharge[ , month:=match(month,month.abb)]

# river_discharge[, foo_date:=as.character(paste(Year, month, Day, sep = "/"))]
# river_discharge[, date_read := as.Date(foo_date, "%Y/%b/%d")]
river_discharge=river_discharge[,.(River, year=Year, month, day=Day, discharge_m3_s)]
river_discharge[, discharge_m3_s:=as.numeric(discharge_m3_s)]

river_discharge[, River:=gsub("Cano", "Cano Quebrado", River)]
river_discharge[, River:=gsub("Ciri", "Ciri grande", River)]
river_discharge[, unique(River)]


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#                   II. River - watershed connection
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
river_names              = readOGR(dsn="./Data/Rivers",layer="Rivers_PCWCopy")
river_names=data.table(river_names@data)
river_names=river_names[,.(NOMBRE, SUBCUENC_2)]

river_names[, River:=simpleCap(NOMBRE)]
spanish_cano=river_names[, unique(River)][3]
river_names[, River:=gsub(spanish_cano, "Cano Quebrado", River)]
river_names[, unique(River)]

setkey(river_names,     River)
setkey(river_discharge, River)

river_discharge=river_names[river_discharge]
river_discharge=river_discharge[complete.cases(NOMBRE)]
river_discharge=river_discharge[,.(River, SUBCUENC_2, year, month, day, discharge_m3_s)]

weird_char = unique(river_discharge$SUBCUENC_2)[1]
weird_char = substr(weird_char, 1, 4) # win
# weird_char = substr(weird_char, 1, 3) # mac

river_discharge[, SUBCUENC_2 := gsub(weird_char, "Rio", SUBCUENC_2)]
river_discharge[, SUBCUENC_2 := gsub("BoquerÃ³n", "Boqueron", SUBCUENC_2)]
river_discharge[, SUBCUENC_2 := gsub("CaÃ±o", "Cano", SUBCUENC_2)]

weird_char_ciri=unique(river_discharge$SUBCUENC_2)[4]
weird_char_ciri=substr(weird_char_ciri, 5, 8)
weird_char_pequeni=unique(river_discharge$SUBCUENC_2)[6]
weird_char_pequeni=substr(weird_char_pequeni, 5, 13)
river_discharge[, SUBCUENC_2 := gsub(weird_char_ciri,    "Ciri",    SUBCUENC_2)] # win
river_discharge[, SUBCUENC_2 := gsub(weird_char_pequeni, "Pequeni", SUBCUENC_2)] # win
river_discharge[, SUBCUENC_2 := gsub("GatÃºn", "Gatun", SUBCUENC_2)]
river_discharge[, unique(SUBCUENC_2)]

river_discharge[year==2016 & River=="Gatun",.N, by="month"]
river_discharge[year==2016 & River=="Chagres",.N, by="month"]
river_discharge[,.N, by=River]

# Except Indio, which will be thrown out, the panel is almost balanced. Only Chagres has more data which may mean there is "extra" data
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#                   II. Hectares in each region-year
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PIEA                 = readOGR(dsn="./Data/PIEA",       layer="PIEA_polygons")
watershed_original   = readOGR(dsn="./Data/Watersheds", layer="Watersheds_PCW")
watershed_original   = gBuffer(watershed_original,    byid = TRUE, width = 0)
watershed_PIEA_final = raster::intersect(PIEA, watershed_original)
# writeOGR(watershed_PIEA_final, 
#          dsn="./Data/PIEA", layer="PIEA_by_watershed", driver="ESRI Shapefile")


watershed_PIEA_final=FN_area_sp(watershed_PIEA_final, "area_PIEA_watershed")
watershed_PIEA_final=watershed_PIEA_final[,.(Uso, SUBCUENC_2, area_PIEA_watershed_ha, area_watershed_ha=area_Water)]
watershed_PIEA_final[, Uso:=gsub(": Programa PIEA", "", Uso)]
watershed_PIEA_final_by_land_use = watershed_PIEA_final[,   sum(area_PIEA_watershed_ha),                          by="Uso"]
watershed_PIEA_final_by_watershed= watershed_PIEA_final[, .(sum(area_PIEA_watershed_ha), sum(area_watershed_ha)), by="SUBCUENC_2"]
watershed_PIEA_final_by_watershed[, percent_area:=V1/V2*100]
setkey(watershed_PIEA_final_by_watershed, percent_area)

watershed_PIEA_final[, SUBCUENC_2 := gsub(weird_char, "Rio", SUBCUENC_2)]
watershed_PIEA_final[, SUBCUENC_2 := gsub("BoquerÃ³n", "Boqueron", SUBCUENC_2)]
watershed_PIEA_final[, SUBCUENC_2 := gsub("CaÃ±o", "Cano", SUBCUENC_2)]
watershed_PIEA_final[, SUBCUENC_2 := gsub(weird_char_ciri, "Ciri", SUBCUENC_2)]
watershed_PIEA_final[, SUBCUENC_2 := gsub(weird_char_pequeni, "Pequeni", SUBCUENC_2)] # mac
watershed_PIEA_final[, SUBCUENC_2 := gsub("GatÃºn", "Gatun", SUBCUENC_2)]
watershed_PIEA_final[, unique(SUBCUENC_2)]


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#                   III. Rainfall (Other climatic variables?)
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

################
# rainfall_PIEA=read.dta13("./Data/Rainfall/acp_15Minstorms_Steve_v18112016.dta")
# rainfall_PIEA=data.table(rainfall_PIEA)
# rainfall_PIEA[,month:=substr(date, 4, 5)]
# rainfall_PIEA[,day  :=substr(date, 1, 2)]
# rainfall_PIEA[,total_rain_day:=sum(Totalrain), by=c("site", "Year", "month", "day")]
# rainfall_PIEA=unique(rainfall_PIEA, by=c("site", "Year", "month", "day"))
# rainfall_PIEA[,month:=as.numeric(month)]
# rainfall_PIEA[,Year :=as.numeric(Year)]
# rainfall_PIEA[,day  :=as.numeric(day)]

################
rainfall_PIEA2=read.csv("./Data/Rainfall/ACP_Rainfall_hourly.csv")
rainfall_PIEA2=data.table(rainfall_PIEA2)
rainfall_PIEA2[,DATETIME.dd.mm.yyyy.hh.mm.:=as.character(DATETIME.dd.mm.yyyy.hh.mm.)]
rainfall_PIEA2[, day:=substr(DATETIME.dd.mm.yyyy.hh.mm., 1, regexpr('/', DATETIME.dd.mm.yyyy.hh.mm.)-1)]
rainfall_PIEA2[,first_foo:=substr(DATETIME.dd.mm.yyyy.hh.mm., regexpr('/', DATETIME.dd.mm.yyyy.hh.mm.)+1, 20)]
rainfall_PIEA2[, month:=substr(first_foo, 1, regexpr('/', first_foo)-1)]
rainfall_PIEA2[,first_foo:=substr(first_foo, regexpr('/', first_foo)+1, 20)]
rainfall_PIEA2[, year:=substr(first_foo, 1, regexpr(' ', first_foo)-1)]

rainfall_PIEA2[, day:=  as.numeric(as.character(day))]
rainfall_PIEA2[, month:=as.numeric(as.character(month))]
rainfall_PIEA2[, year:= as.numeric(as.character(year))]
rainfall_PIEA2=rainfall_PIEA2[, .(Station, year, month, day, total_rain_day=Rain..mm.)]
rainfall_PIEA2[, total_rain_day:=sum(total_rain_day), by=c("Station", "year", "month", "day")]
rainfall_PIEA2=unique(rainfall_PIEA2, by=c("Station", "year", "month", "day"))

####### check these two for rainfall before 2004
rainfall_PIEA2[,unique(Station)]

rainfall_PIEA2[Station== "CHORRO", .N, by="year"]


# for (i in 1:nrow(rivers_used)) {
#   temp=rainfall_PIEA2[Station== rivers_used[i], .N, by="year"]
#   print(rivers_used[i])
#   print(temp)
#   readline(prompt="Press [enter] to continue")
# }
######## only SANMIGUEL and CHAGRECITO don't have enough data. Unfortunately, ZANGUENA only has data starting 2004. This is in Cano Quebrado catchment so would have been helpful.
setnames(rainfall_PIEA2, "Station", "site")
###############


rainfall_stations = readOGR(dsn="./Data/Rainfall/stations", layer="stations")
# foo1 = watershed_original[!is.na(over(rainfall_stations, as(watershed_original,"SpatialPolygons"))),]

bar_1=over(rainfall_stations, as(watershed_original,"SpatialPolygons"))
bar_1=data.table(bar_1)
setnames(bar_1, "bar_1", "over_id")
bar_2=data.table(bar_1, rainfall_stations@data)
bar_2=bar_2[complete.cases(over_id)]
bar_3=data.table(watershed_original@data)

setkey(bar_2, over_id)
setkey(bar_3, OBJECTID_1)
bar= bar_2[bar_3]
bar=bar[complete.cases(CODENAME)]
setkey(bar, CODENAME)
rainfall_stations=bar[,.(OBJECTID, over_id, CODENAME, SUBCUENC_2)]
rainfall_stations[, CODENAME:=gsub(" ", "", CODENAME, fixed = TRUE)]
setkey(rainfall_stations, CODENAME)
setkey(rainfall_PIEA2, site)
rainfall_PIEA2=rainfall_stations[rainfall_PIEA2]
rainfall_PIEA2=rainfall_PIEA2[complete.cases(CODENAME) & complete.cases(SUBCUENC_2)]
rainfall_PIEA2=rainfall_PIEA2[,.(Station= CODENAME, SUBCUENC_2, date=as.Date(paste(year, month, day, sep = "-")), year, month, day, total_rain_day)]
# rainfall_PIEA2[, date_read:=as.Date(date, "dd/mm/yyyy")]
# rainfall_PIEA2[, date_read:=as.Date(date, "%d/%m/%Y")]

# 
# ggplot(data = rainfall_PIEA2[Station=="CANONES"], aes(x=date_read, y=total_rain_day))+
#   geom_line(size=1.1)+
#   # coord_cartesian(ylim=c(0, 400)) +
#   scale_x_date(labels = date_format("%m-%Y")) #+ 
# # scale_y_discrete(breaks=seq(0, 400, 100))  # Ticks from 0-10, every .25
# rainfall_PIEA2[, unique(Station)]

rainfall_PIEA2[,        unique(SUBCUENC_2)]
# watershed_PIEA_final[, unique(SUBCUENC_2)]
# river_discharge[, unique(SUBCUENC_2)]
# str(river_discharge)
# str(rainfall_PIEA2)

rainfall_PIEA2[SUBCUENC_2== rainfall_PIEA2[,        unique(SUBCUENC_2)][6], unique(Station)]
rainfall_PIEA2[Station   == rainfall_PIEA2[SUBCUENC_2==rainfall_PIEA2[,        unique(SUBCUENC_2)][6], unique(Station)]]
# rainfall_PIEA[Station  == rainfall_PIEA2[SUBCUENC_2==rainfall_PIEA2[,        unique(SUBCUENC_2)][6], unique(Station)]]
### looks good \/

rainfall_PIEA2[, SUBCUENC_2 := gsub(weird_char, "Rio", SUBCUENC_2)]
rainfall_PIEA2[, SUBCUENC_2 := gsub("BoquerÃ³n", "Boqueron", SUBCUENC_2)]
rainfall_PIEA2[, SUBCUENC_2 := gsub("CaÃ±o", "Cano", SUBCUENC_2)]
rainfall_PIEA2[, SUBCUENC_2 := gsub(weird_char_ciri, "Ciri", SUBCUENC_2)] # win
rainfall_PIEA2[, SUBCUENC_2 := gsub(weird_char_pequeni, "Pequeni", SUBCUENC_2)] # win
rainfall_PIEA2[, SUBCUENC_2 := gsub("GatÃºn", "Gatun", SUBCUENC_2)]
rainfall_PIEA2[, unique(SUBCUENC_2)]

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#                   IV. Seasons
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
seasons=read.csv("./Data/seasons.csv")
seasons=data.table(seasons)
seasons[, Dry_season_start_date := as.Date(Dry_season_start, "%d-%b-%y")]
seasons[, Dry_season_end_date   := as.Date(Dry_season_end,   "%d-%b-%y")]
seasons=seasons[,.(YEAR, Dry_season_start_date, Dry_season_end_date)]
seasons[, Dry_season_length := Dry_season_end_date - Dry_season_start_date]

setkey(seasons, YEAR)
setkey(river_discharge, year)


river_discharge=river_discharge[seasons]
river_discharge=river_discharge[complete.cases(River)]
river_discharge[, date_disch:=as.Date(paste(year, month, day, sep = "/"))]
river_discharge=river_discharge[complete.cases(date_disch)]
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#                   V. Merge
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
setkey(rainfall_PIEA2,  SUBCUENC_2, year, month, day)
setkey(river_discharge, SUBCUENC_2, year, month, day)

unique(rainfall_PIEA2,  by="SUBCUENC_2")
unique(river_discharge, by="SUBCUENC_2")

# setkey(watershed_PIEA_final, SUBCUENC_2, year, month, day)
# setkey(watershed_PIEA_final, SUBCUENC_2, Uso)

# data_reg = river_discharge[rainfall_PIEA2, allow.cartesian=T, all.x=T]
# data_reg = rainfall_PIEA2[river_discharge, allow.cartesian=T]
# data_reg = data_reg[complete.cases(date_read)]
# data_reg = data_reg[complete.cases(total_rain_day) & complete.cases(discharge_m3_s)]

data_reg = merge(river_discharge, rainfall_PIEA2, by.x=c("SUBCUENC_2", "year", "month", "day"), by.y=c("SUBCUENC_2", "year", "month", "day") , all.x=T)
# data_reg = data_reg[year > 2004]
data_reg = data_reg[year > 2003]
data_reg = data_reg[,.(SUBCUENC_2, River, year, month, day, Dry_season_start_date, Dry_season_end_date, discharge_m3_s, Station, total_rain_day)]
data_reg[, date_read := as.Date(paste(year, month, day, sep = "-"))]
data_reg=data_reg[complete.cases(date_read)]
data_reg[is.na(total_rain_day), total_rain_day:=0]

# rivers_used=data_reg[, unique(Station), by="SUBCUENC_2"]
# rivers_used=rivers_used[,2]
data_reg[, day_of_dry_season := date_read - Dry_season_start_date]
data_reg[, day_of_wet_season := date_read - (Dry_season_end_date+1)]
data_reg[, day_of_season     := ifelse(date_read < Dry_season_end_date+1, day_of_dry_season, day_of_wet_season)]
data_reg[, dry_dummy         := ifelse(date_read < Dry_season_end_date+1, 1, 0)]
data_reg=data_reg[year<2016]

######## I think merging discharge and rainfall should be done more carefully



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#                   VI. land use data
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# These are the areas that Blair estimated. I double chekced Trinidad for 2012 and the estimates look good. So I am using the estimates.
# 
land_use=read.csv("./Data/Land Covers/land_use_over_time_R_input.csv")
land_use=data.table(land_use)
land_use[, unique(River)]
land_use=land_use[River!="Las Cascadas"]

land_use=land_use[,foo:=ifelse(X2003==0 & X2008==0 & X2012==0, 1, 0)]
land_use=land_use[foo==0]
land_use=land_use[Land.use!="Water"]



forest=land_use[Land.use=="Mature Forests" | Land.use=="Secondary Forests" | Land.use=="Forest Plantations"]
cols=colnames(forest)[3:5]
forest[, (cols):=lapply(.SD, sum), by="River", .SDcols=cols] 
forest=unique(forest, by="River")
forest=forest[,.(River, f_2003=X2003, f_2008=X2008, f_2012=X2012)]


non_forest=land_use[Land.use=="Pastures" | Land.use=="Crops" | Land.use=="Scrub" | Land.use=="Kans Grass" | Land.use=="Towns" | Land.use=="Barren Soil"]
cols=colnames(non_forest)[3:5]
non_forest[, (cols):=lapply(.SD, sum), by="River", .SDcols=cols] 
non_forest=unique(non_forest, by="River")
non_forest=non_forest[,.(River, n_2003=X2003, n_2008=X2008, n_2012=X2012)]

setkey(forest, River)
setkey(non_forest, River)
net=forest[non_forest]
net[, X2003:=f_2003 - n_2003]
net[, X2008:=f_2008 - n_2008]
net[, X2012:=f_2012 - n_2012]
net=net[,.(River, type="net", X2003, X2008, X2012)]

land_use_fig = copy(land_use)
land_use_fig[, type:=ifelse(Land.use=="Mature Forests" | Land.use=="Secondary Forests" | Land.use=="Forest Plantations", "forest", 
                            ifelse(Land.use=="Pastures" | Land.use=="Crops" | Land.use=="Scrub" | Land.use=="Kans Grass" | Land.use=="Towns" | Land.use=="Barren Soil", "non_forest" 
                              , "other"))]

land_use_fig=land_use_fig[type=="forest" | type== "non_forest"]

col_sum=colnames(land_use_fig)[3:5]
land_use_fig[,(col_sum):=lapply(.SD, sum), by=c("River", "type"), .SDcols=col_sum]
land_use_fig=unique(land_use_fig, by=c("type", "River"))

land_use_fig=land_use_fig[,.(River, type, X2003, X2008, X2012)]
land_use_fig=rbind(land_use_fig, net)

setkey(land_use_fig, River)
land_use_fig=land_use_fig[,.(River, type, X2003, X2008, X2012)]
land_use_fig=melt(land_use_fig, id=c("River", "type"))
land_use_fig[, variable:=ifelse(variable=="X2003", 2003, ifelse(variable=="X2008", 2008, 2012))]
foo_d=land_use_fig[variable==2003, value]
land_use_fig[, foo:=foo_d]
land_use_fig[, foo:=value - foo]

lu_fig1<- ggplot(land_use_fig[type=="forest"], aes(x=factor(variable), y=foo, group=River, col=River))+
  geom_point(size=2)+
  geom_line(size=1.2)+
  theme_bw()+
  xlab("Year")+
  ylab("Ha")+
  ggtitle(paste("forest land"))+
  scale_colour_discrete(guide = 'none') +
  scale_x_discrete(expand=c(0, 1)) +
  geom_dl(aes(label = River), method = list(dl.trans(x = x + 0.2), "last.points", cex = 0.8))


lu_fig3<- ggplot(land_use_fig[type=="net"], aes(x=factor(variable), y=foo, group=River, col=River))+
  geom_point(size=2)+
  geom_line(size=1.2)+
  theme_bw()+
  xlab("Year")+
  ylab("Ha")+
  ggtitle(paste("net forest cover"))+
  scale_colour_discrete(guide = 'none') +
  scale_x_discrete(expand=c(0, 1)) +
  geom_dl(aes(label = River), method = list(dl.trans(x = x + 0.2), "last.points", cex = 0.8))



lu_fig2 <- ggplot(land_use_fig[type=="non_forest"], aes(x=factor(variable), y=foo, group=River, col=River))+
  geom_point(size=2)+
  geom_line(size=1.2)+
  theme_bw()+
  xlab("Year")+
  ylab("Ha")+
  ggtitle(paste("non forest land"))+
  scale_colour_discrete(guide = 'none') +
  scale_x_discrete(expand=c(0, 1)) +
  geom_dl(aes(label = River), method = list(dl.trans(x = x + 0.2), "last.points", cex = 0.8))


###### >>>>> I need to get back to this and add them to the figure with ESE estimates as bars <<<<<<<<<

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ####
########                                  Plot PIEA polygons                                                 ###########
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
county_fills <- readOGR(dsn="C:/Users/mr2284/Dropbox/Research/Panama Canal-My material/Codes/IE/IE_PCW/Data/Watersheds",layer="watersheds_original")

county_fills@data$id = rownames(county_fills@data)
county_fills_2= county_fills@data

PIEA@data$id = rownames(PIEA@data)
PIEA_2= PIEA@data

# install.packages("gpclib")
# gpclibPermit() ## It should return TRUE

county_fills_1 <- tidy(county_fills, region = "id")
fills.df = join(county_fills_1, county_fills@data, by="id")

PIEA_1  <- tidy(PIEA, region = "id")
pills.df = join(PIEA_1, PIEA@data, by="id")

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ####
########                                  Data Analysis           ###########
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
trin     = watershed_PIEA_final_by_watershed[,SUBCUENC_2][25]
ciri     = watershed_PIEA_final_by_watershed[,SUBCUENC_2][31]
cano     = watershed_PIEA_final_by_watershed[,SUBCUENC_2][3]
Boqueron = watershed_PIEA_final_by_watershed[,SUBCUENC_2][4]
Gatun    = watershed_PIEA_final_by_watershed[,SUBCUENC_2][8]

watershed_PIEA_west = watershed_PIEA_final_by_watershed[SUBCUENC_2==trin | SUBCUENC_2==ciri | SUBCUENC_2==cano | SUBCUENC_2==Boqueron | SUBCUENC_2==Gatun]

watershed_PIEA_west = watershed_PIEA_west[ SUBCUENC_2==trin,     SUBCUENC_2:="Trinidad"]
watershed_PIEA_west = watershed_PIEA_west[ SUBCUENC_2==ciri,     SUBCUENC_2:="Ciri grande"]
watershed_PIEA_west = watershed_PIEA_west[ SUBCUENC_2==cano,     SUBCUENC_2:="Cano Quebrado"]
watershed_PIEA_west = watershed_PIEA_west[ SUBCUENC_2==Gatun,    SUBCUENC_2:="Gatun"]
watershed_PIEA_west = watershed_PIEA_west[ SUBCUENC_2==Boqueron, SUBCUENC_2:="Boqueron"]

river_discharge_west= river_discharge[River=="Trinidad" | River=="Ciri grande" | River=="Cano Quebrado" | River=="Boqueron" | River=="Gatun"]
river_discharge_west=river_discharge_west[date_disch < Dry_season_end_date]
river_discharge_west[, tot_discharge := discharge_m3_s*24*3600]  # M3

setkey(watershed_PIEA_west, SUBCUENC_2)
setkey(river_discharge_west, River)

watershed_PIEA_west=watershed_PIEA_west[river_discharge_west]

data_pre=watershed_PIEA_west[year < 2008]

data_pre[, discharge_per_ha := tot_discharge/V2] # m3 per day per hectare
data_pre[, extra_discharge  := discharge_per_ha * V1 * .2] # m3 per day for the entire catchment under 20% ESE
data_pre[, mean_extra_discharge :=mean(extra_discharge), by=c("SUBCUENC_2", "month")]
data_pre[, sd_extra_discharge   :=sd(extra_discharge), by=c("SUBCUENC_2", "month")]
data_pre=unique(data_pre, by=c("SUBCUENC_2", "month"))

data_pre=data_pre[,.(SUBCUENC_2, month, mean_extra_discharge, sd_extra_discharge)]


summary_PIEA=watershed_PIEA_west[,.(Watershed=SUBCUENC_2, PIEA_hecatres=V1, Watershed_hectares=V2, percent_area_in_PIEA=percent_area)]
summary_PIEA=unique(summary_PIEA, by="Watershed")
summary_PIEA=rbind(summary_PIEA, list("Chagres", 0, 0, 0), list("Pequeni", 0, 0, 0))

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ####
#                   0. Teeatment before and after ####
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#################
data_reg_copy_daily = copy(data_reg)
data_reg_copy_daily[,total_rain_day:=mean(total_rain_day), by=c("River", "year", "month", "day")]
data_reg_copy_daily=unique(data_reg_copy_daily, by=c("River", "year", "month", "day"))
data_reg_copy_daily[, tot_discharge  := discharge_m3_s*24*3600] # total daily Million m3
data_reg_copy_daily[, lag.rain_day   := c(NA, total_rain_day[-.N]), by=c("SUBCUENC_2", "year")]
data_reg_copy_daily[, lag.rain_day_2 := c(NA, lag.rain_day[-.N]),   by=c("SUBCUENC_2", "year")]
data_reg_copy_daily[, rain_past_2_days := lag.rain_day + lag.rain_day_2]
data_reg_copy_daily[, lag.discharge  := c(NA, tot_discharge[-.N]),  by=c("SUBCUENC_2", "year")]
data_reg_daily_dry = data_reg_copy_daily[dry_dummy==1]
data_reg_daily_wet = data_reg_copy_daily[dry_dummy==0]

# 
# FN_before_after_by_river     <- function(year_pre, year_post, River_tr) {
#   # dt=data_reg_copy_daily[(River=="Trinidad" | River=="Ciri grande" | River=="Cano Quebrado")]
#   dt=data_reg_copy_daily[(River==River_tr)]
#   dt = dt[year < year_pre | year > year_post][ ,year_treat:= ifelse(year>2007, 1, 0)]
#   coefs_DiD = data.table(month=1:12, coefficient_DiD = rep(0 , 12), standard_error_DiD= rep(0, 12))
#   for(i in 1:12){
#     DiD_prepost = lm(tot_discharge ~ year_treat + total_rain_day + lag.rain_day + day_of_season + lag.discharge, 
#                      data = dt[ month == i])
#     beta_DiD = summary(DiD_prepost)$coefficients[2,1]
#     std_error= summary(DiD_prepost)$coefficients[2,2]
#     coefs_DiD[i, 2] = beta_DiD
#     coefs_DiD[i, 3] = std_error
#   }
#   
#   dt_ESE=data_pre[SUBCUENC_2==River_tr]
# 
#   l=ggplot(data = coefs_DiD, aes(x=factor(month), y=coefficient_DiD))+
#     geom_errorbar(aes(ymin=coefficient_DiD - 2.866 * standard_error_DiD , ymax=coefficient_DiD + 2.866 * standard_error_DiD), width=.1) +
#     geom_line(aes(group=1)) +
#     geom_point() +
#         geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge), 
#                   width=.2, col="red") +
#     theme_bw()+
#     xlab("month")+
#     ylab("Diff in Diff Coefficient")+
#     ggtitle(paste("Before", year_pre, "and after", year_post, "\nfor", River_tr, sep = " "))
#   return(l)
# }
# 
# 



FN_before_after_by_river     <- function(year_pre, year_post, River_tr) {
  # dt=data_reg_copy_daily[(River=="Trinidad" | River=="Ciri grande" | River=="Cano Quebrado")]
  dt=data_reg_copy_daily[River==River_tr & month < 5]
  dt = dt[year < year_pre | year > year_post][ ,year_treat:= ifelse(year>2007, 1, 0)]
  dt_pre=dt[year_treat==0 ,.(year, month, day, tot_discharge)]
  dt_pos=dt[year_treat==1 ,.(year, month, day, tot_discharge)]
  
  dt_pre[,mean_disch_pre:=mean(tot_discharge), by="month"]
  dt_pre[,foo:=.N, by="month"]
  dt_pre[,sd_disch_pre  :=  sd(tot_discharge), by= "month"]
  dt_pre[,sd_disch_pre  :=  (sd_disch_pre)^2/foo]
  dt_pre=unique(dt_pre, by="month")
  dt_pre=dt_pre[,.(month, mean_disch_pre, sd_disch_pre)]
  
  dt_pos[,mean_disch_pos:=mean(tot_discharge), by="month"]
  dt_pos[,foo:=.N, by="month"]
  dt_pos[,sd_disch_pos  :=  sd(tot_discharge), by= "month"]
  dt_pos[,sd_disch_pos  :=  (sd_disch_pos)^2/foo]
  dt_pos=unique(dt_pos, by="month")
  dt_pos=dt_pos[,.(month, mean_disch_pos, sd_disch_pos)]
  
  setkey(dt_pre, month)
  setkey(dt_pos, month)
  dt=dt_pre[dt_pos]
  dt[, sd:=sqrt(sd_disch_pre + sd_disch_pos)]
  dt[, mean:=mean_disch_pos - mean_disch_pre]
  
  dt_ESE=data_pre[SUBCUENC_2==River_tr & month < 5]
  
  l=ggplot(data = dt, aes(x=factor(month), y=mean))+
    geom_errorbar(aes(ymin=mean - 1.96 * sd , ymax=mean + 1.96 * sd), width=.1) +
    geom_line(aes(group=1)) +
    geom_point() +
    geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge), 
                  width=.2, col="red") +
    theme_bw()+
    xlab("month")+
    ylab("Change in daily discharge (m3)")+
    ggtitle(paste("Before", year_pre, "and after", year_post, "\nfor", River_tr, sep = " "))
  return(l)
}



## West Side
a1=FN_before_after_by_river(2008, 2012, "Trinidad")
a3=FN_before_after_by_river(2008, 2012, "Ciri grande")
a2=FN_before_after_by_river(2008, 2012, "Cano Quebrado")


a4=FN_before_after_by_river(2008, 2012, "Boqueron")
a5=FN_before_after_by_river(2008, 2012, "Chagres")
a6=FN_before_after_by_river(2008, 2012, "Gatun")
a7=FN_before_after_by_river(2008, 2012, "Pequeni")


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ####
#                   0. Monthly regressions for the entire watershed ####
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#################

FN_coefficients_DiD_monthly     <- function(year_pre, year_post) {
  # dt=data_reg_copy_daily[(River=="Trinidad" | River=="Ciri grande" | River=="Cano Quebrado")]
  dt=copy(data_reg_copy_daily)
  dt = dt[year < year_pre | year > year_post][ ,year_treat:= ifelse(year>2007, 1, 0)]
  dt=dt[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
  coefs_DiD = data.table(month=1:12, coefficient_DiD = rep(0 , 12), standard_error_DiD= rep(0, 12))
  for(i in 1:12){
    # DiD_prepost = lm(tot_discharge ~ year_treat + total_rain_day + lag.rain_day + day_of_season + lag.discharge,
    #                  data = dt[ month == i])
    DiD_prepost = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                     + factor(year)
                     , data = dt[ month == i])
    beta_DiD = summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),1]
    std_error= summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),2]
    coefs_DiD[i, 2] = beta_DiD
    coefs_DiD[i, 3] = std_error
  }
  # dt_ESE=data_pre[SUBCUENC_2==River_tr]
  
  l=ggplot(data = coefs_DiD, aes(x=factor(month), y=coefficient_DiD, group=1))+
    geom_errorbar(aes(ymin=coefficient_DiD - 2.866 * standard_error_DiD , ymax=coefficient_DiD + 2.866 * standard_error_DiD), width=.1) +
    geom_line() +
    geom_point() +
    theme_bw()+
    # geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge),
    #               width=.2, col="red") +
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle(paste("Before", year_pre, "and after", year_post, sep = " "))
  return(l)
}

b1=FN_coefficients_DiD_monthly(2008, 2012)
b2=FN_coefficients_DiD_monthly(2007, 2012)
b3=FN_coefficients_DiD_monthly(2008, 2013)
b4=FN_coefficients_DiD_monthly(2007, 2013)


FN_coefficients_DiD_monthly_lag     <- function(year_pre, year_post) {
  # dt=data_reg_copy_daily[(River=="Trinidad" | River=="Ciri grande" | River=="Cano Quebrado")]
  dt=copy(data_reg_copy_daily)
  dt = dt[year < year_pre | year > year_post][ ,year_treat:= ifelse(year>2007, 1, 0)]
  dt=dt[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
  coefs_DiD = data.table(month=1:12, coefficient_DiD = rep(0 , 12), standard_error_DiD= rep(0, 12))
  for(i in 1:12){
    # DiD_prepost = lm(tot_discharge ~ year_treat + total_rain_day + lag.rain_day + day_of_season + lag.discharge,
    #                  data = dt[ month == i])
    DiD_prepost = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                     + factor(year)  + lag.discharge
                     , data = dt[ month == i])
    beta_DiD = summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),1]
    std_error= summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),2]
    coefs_DiD[i, 2] = beta_DiD
    coefs_DiD[i, 3] = std_error
  }
  # dt_ESE=data_pre[SUBCUENC_2==River_tr]
  
  l=ggplot(data = coefs_DiD, aes(x=factor(month), y=coefficient_DiD, group=1))+
    geom_errorbar(aes(ymin=coefficient_DiD - 2.866 * standard_error_DiD , ymax=coefficient_DiD + 2.866 * standard_error_DiD), width=.1) +
    geom_line() +
    geom_point() +
    # geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge),
    #               width=.2, col="red") +
    theme_bw()+
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle(paste("Before", year_pre, "and after", year_post, sep = " "))
  return(l)
}

b5=FN_coefficients_DiD_monthly_lag(2008, 2012)
b6=FN_coefficients_DiD_monthly_lag(2007, 2012)
b7=FN_coefficients_DiD_monthly_lag(2008, 2013)
b8=FN_coefficients_DiD_monthly_lag(2007, 2013)

### changing treatment year to 2010
FN_coefficients_DiD_monthly_lag2     <- function(year_pre, year_post) {
  # dt=data_reg_copy_daily[(River=="Trinidad" | River=="Ciri grande" | River=="Cano Quebrado")]
  dt=copy(data_reg_copy_daily)
  dt = dt[year < year_pre | year > year_post][ ,year_treat:= ifelse(year>2009, 1, 0)]
  dt=dt[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
  coefs_DiD = data.table(month=1:12, coefficient_DiD = rep(0 , 12), standard_error_DiD= rep(0, 12))
  for(i in 1:12){
    # DiD_prepost = lm(tot_discharge ~ year_treat + total_rain_day + lag.rain_day + day_of_season + lag.discharge,
    #                  data = dt[ month == i])
    DiD_prepost = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                     + factor(year)  + lag.discharge
                     , data = dt[ month == i])
    beta_DiD = summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),1]
    std_error= summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),2]
    coefs_DiD[i, 2] = beta_DiD
    coefs_DiD[i, 3] = std_error
  }
  # dt_ESE=data_pre[SUBCUENC_2==River_tr]
  
  l=ggplot(data = coefs_DiD, aes(x=factor(month), y=coefficient_DiD, group=1))+
    geom_errorbar(aes(ymin=coefficient_DiD - 2.866 * standard_error_DiD , ymax=coefficient_DiD + 2.866 * standard_error_DiD), width=.1) +
    geom_line() +
    geom_point() +
    # geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge),
    #               width=.2, col="red") +
    theme_bw()+
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle(paste("Before", year_pre, "and after", year_post, sep = " "))
  return(l)
}

b15=FN_coefficients_DiD_monthly_lag2(2010, 2012)
b16=FN_coefficients_DiD_monthly_lag2(2008, 2012)
b17=FN_coefficients_DiD_monthly_lag2(2010, 2013)
b18=FN_coefficients_DiD_monthly_lag2(2007, 2013)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ####
#                   0. Annual regressions for the entire watershed for the dry season ####
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#################

FN_coefficients_DiD_annual_dry     <- function(year_pre) {
  dt=copy(data_reg_copy_daily)
  dt=dt[dry_dummy==1]
  coefs_DiD=data.table()
  for (i in year_pre:2015) {
    dt_1=rbind(dt[year< year_pre], dt[year== i])
    dt_1[, year_treat:=ifelse(year==i, 1, 0)]
    dt_1=dt_1[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
    
    DiD_annual = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                    # + factor(year) + lag.discharge
                    , data = dt_1)
    beta_DiD = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),1]
    std_DiD  = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),2]
    dt_2=data.table(year=i, beta_DiD, std_DiD)
    coefs_DiD=rbind(coefs_DiD, dt_2)
  }
  l=ggplot(data = coefs_DiD, aes(x=factor(year), y=beta_DiD, group=1))+
    geom_errorbar(aes(ymin=beta_DiD - 1.96 * std_DiD , ymax=beta_DiD + 1.96 * std_DiD), width=.1) +
    geom_line() +
    geom_point() +
    # geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge),
    #               width=.2, col="red") +
    theme_bw()+
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle("change in dry season discharge\nwithout lagged discharge")
  return(l)
}

c1=FN_coefficients_DiD_annual_dry(2008)


FN_coefficients_DiD_annual_lag_dry     <- function(year_pre) {
  dt=copy(data_reg_copy_daily)
  dt=dt[dry_dummy==1]
  coefs_DiD=data.table()
  for (i in year_pre:2015) {
    dt_1=rbind(dt[year< year_pre], dt[year== i])
    dt_1[, year_treat:=ifelse(year==i, 1, 0)]
    dt_1=dt_1[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
    
    DiD_annual = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                     + lag.discharge #+ factor(year)
                    , data = dt_1)
    beta_DiD = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),1]
    std_DiD  = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),2]
    dt_2=data.table(year=i, beta_DiD, std_DiD)
    coefs_DiD=rbind(coefs_DiD, dt_2)
  }
  l=ggplot(data = coefs_DiD, aes(x=factor(year), y=beta_DiD, group=1))+
    geom_errorbar(aes(ymin=beta_DiD - 1.96 * std_DiD , ymax=beta_DiD + 1.96 * std_DiD), width=.1) +
    geom_line() +
    geom_point() +
    # geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge),
    #               width=.2, col="red") +
    theme_bw()+
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle("change in dry season discharge\nwith lagged discharge")
  return(l)
}

d1=FN_coefficients_DiD_annual_lag_dry(2008)


FN_coefficients_DiD_annual_wet     <- function(year_pre) {
  dt=copy(data_reg_copy_daily)
  dt=dt[dry_dummy==0]
  coefs_DiD=data.table()
  for (i in year_pre:2015) {
    dt_1=rbind(dt[year< year_pre], dt[year== i])
    dt_1[, year_treat:=ifelse(year==i, 1, 0)]
    dt_1=dt_1[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
    
    DiD_annual = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                    # + factor(year) + lag.discharge
                    , data = dt_1)
    beta_DiD = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),1]
    std_DiD  = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),2]
    dt_2=data.table(year=i, beta_DiD, std_DiD)
    coefs_DiD=rbind(coefs_DiD, dt_2)
  }
  l=ggplot(data = coefs_DiD, aes(x=factor(year), y=beta_DiD, group=1))+
    geom_errorbar(aes(ymin=beta_DiD - 1.96 * std_DiD , ymax=beta_DiD + 1.96 * std_DiD), width=.1) +
    geom_line() +
    geom_point() +
    # geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge),
    #               width=.2, col="red") +
    theme_bw()+
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle("change in wet season discharge\nwithout lagged discharge")
    
  return(l)
}

c2=FN_coefficients_DiD_annual_wet(2008)


FN_coefficients_DiD_annual_lag_wet     <- function(year_pre) {
  dt=copy(data_reg_copy_daily)
  dt=dt[dry_dummy==0]
  coefs_DiD=data.table()
  for (i in year_pre:2015) {
    dt_1=rbind(dt[year< year_pre], dt[year== i])
    dt_1[, year_treat:=ifelse(year==i, 1, 0)]
    dt_1=dt_1[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
    
    DiD_annual = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                     + lag.discharge #+ factor(year)
                    , data = dt_1)
    beta_DiD = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),1]
    std_DiD  = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),2]
    dt_2=data.table(year=i, beta_DiD, std_DiD)
    coefs_DiD=rbind(coefs_DiD, dt_2)
  }
  l=ggplot(data = coefs_DiD, aes(x=factor(year), y=beta_DiD, group=1))+
    geom_errorbar(aes(ymin=beta_DiD - 1.96 * std_DiD , ymax=beta_DiD + 1.96 * std_DiD), width=.1) +
    geom_line() +
    geom_point() +
    # geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge),
    #               width=.2, col="red") +
    theme_bw()+
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle("change in wet season discharge\nwithout lagged discharge")
  return(l)
}

d2=FN_coefficients_DiD_annual_lag_wet(2008)

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ####
#                   0. Monthly regressions for the entire watershed for finding N ####
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#################

FN_coefficients_DiD_monthly_nobs     <- function(year_pre, year_post) {
  dt=copy(data_reg_copy_daily)
  dt = dt[year < year_pre | year > year_post][ ,year_treat:= ifelse(year>2007, 1, 0)]
  dt=dt[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
  coefs_DiD = data.table(month=1:12, coefficient_DiD = rep(0 , 12), standard_error_DiD= rep(0, 12))
  for(i in 1:12){
    DiD_prepost = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                     + factor(year), data = dt[ month == i])
    beta_DiD = summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),1]
    std_error= summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),2]
    coefs_DiD[i, 2] = beta_DiD
    coefs_DiD[i, 3] = std_error
  }
  coefs_DiD[, CI_lower:=coefficient_DiD - 2.866 * standard_error_DiD]
  coefs_DiD[, CI_upper:=coefficient_DiD + 2.866 * standard_error_DiD]
  nnss=nobs(DiD_prepost)
  
  coefs_DiD[, m:= ceiling(((2.866 * standard_error_DiD) * sqrt(nnss-2)/coefficient_DiD)^2) + 2]
  coefs_DiD[, CI_lower_corrected:=coefficient_DiD - 2.866 * standard_error_DiD  * sqrt(nnss-2)/sqrt(m-2)]
  coefs_DiD[, CI_upper_corrected:=coefficient_DiD + 2.866 * standard_error_DiD  * sqrt(nnss-2)/sqrt(m-2)]
  coefs_DiD[month > 4, c("CI_lower_corrected", "CI_upper_corrected"):=0]
  coefs_DiD[, m:=ifelse(coefficient_DiD < 0, "", m)]
  
  l=ggplot(data = coefs_DiD[month<5], aes(x=factor(month), y=coefficient_DiD, group=1))+
    geom_errorbar(aes(ymin=CI_lower_corrected , ymax=CI_upper_corrected), width=.1) +
    geom_line() +
    geom_point() +
    geom_text(aes(label=m),vjust=-1)+
    theme_bw()+
    # geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge),
    #               width=.2, col="red") +
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle(paste("Before", year_pre, "and after", year_post, "\nwithout lagged discharge", "\nN= ", nnss,sep = " "))
  return(l)
}

b21=FN_coefficients_DiD_monthly_nobs(2008, 2012)


FN_coefficients_DiD_monthly_lag_nobs     <- function(year_pre, year_post) {
  # dt=data_reg_copy_daily[(River=="Trinidad" | River=="Ciri grande" | River=="Cano Quebrado")]
  dt=copy(data_reg_copy_daily)
  dt = dt[year < year_pre | year > year_post][ ,year_treat:= ifelse(year>2007, 1, 0)]
  dt=dt[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
  coefs_DiD = data.table(month=1:12, coefficient_DiD = rep(0 , 12), standard_error_DiD= rep(0, 12))
  for(i in 1:12){
    DiD_prepost = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                     + factor(year)  + lag.discharge
                     , data = dt[ month == i])
    beta_DiD = summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),1]
    std_error= summary(DiD_prepost)$coefficients[nrow(summary(DiD_prepost)$coefficients),2]
    coefs_DiD[i, 2] = beta_DiD
    coefs_DiD[i, 3] = std_error
  }
  coefs_DiD[, CI_lower:=coefficient_DiD - 2.866 * standard_error_DiD]
  coefs_DiD[, CI_upper:=coefficient_DiD + 2.866 * standard_error_DiD]
  nnss=nobs(DiD_prepost)
  
  coefs_DiD[, m:= ceiling(((2.866 * standard_error_DiD) * sqrt(nnss-2)/coefficient_DiD)^2) + 2]
  coefs_DiD[, CI_lower_corrected:=coefficient_DiD - 2.866 * standard_error_DiD  * sqrt(nnss-2)/sqrt(m-2)]
  coefs_DiD[, CI_upper_corrected:=coefficient_DiD + 2.866 * standard_error_DiD  * sqrt(nnss-2)/sqrt(m-2)]
  coefs_DiD[month > 4, c("CI_lower_corrected", "CI_upper_corrected"):=0]
  coefs_DiD[, m:=ifelse(coefficient_DiD < 0, "", m)]

  l=ggplot(data = coefs_DiD[month<5], aes(x=factor(month), y=coefficient_DiD, group=1))+
    geom_errorbar(aes(ymin=CI_lower_corrected , ymax=CI_upper_corrected), width=.1) +
    geom_line() +
    geom_point() +
    geom_text(aes(label=m),vjust=-1)+
    theme_bw()+
    # geom_errorbar(data = dt_ESE, aes(y=mean_extra_discharge, ymin=mean_extra_discharge - 1.96 * sd_extra_discharge , ymax=mean_extra_discharge + 1.96 * sd_extra_discharge),
    #               width=.2, col="red") +
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle(paste("Before", year_pre, "and after", year_post, "\nwith lagged discharge", "\nN= ", nnss,sep = " "))
  return(l)
}

b22=FN_coefficients_DiD_monthly_lag_nobs(2008, 2012)


FN_coefficients_DiD_annual_dry_nobs     <- function(year_pre) {
  dt=copy(data_reg_copy_daily)
  dt=dt[dry_dummy==1]
  coefs_DiD=data.table()
  for (i in year_pre:2015) {
    dt_1=rbind(dt[year< year_pre], dt[year== i])
    dt_1[, year_treat:=ifelse(year==i, 1, 0)]
    dt_1=dt_1[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
    
    DiD_annual = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                    # + factor(year) + lag.discharge
                    , data = dt_1)
    coefficient_DiD = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),1]
    standard_error_DiD  = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),2]
    dt_2=data.table(year=i, coefficient_DiD, standard_error_DiD)
    coefs_DiD=rbind(coefs_DiD, dt_2)
  }

  coefs_DiD[, CI_lower:=coefficient_DiD - 1.96 * standard_error_DiD]
  coefs_DiD[, CI_upper:=coefficient_DiD + 1.96 * standard_error_DiD]
  nnss=nobs(DiD_annual)
  
  coefs_DiD[, m:= ceiling(((1.96 * standard_error_DiD) * sqrt(nnss-2)/coefficient_DiD)^2) + 2]
  coefs_DiD[, CI_lower_corrected:=coefficient_DiD - 1.96 * standard_error_DiD  * sqrt(nnss-2)/sqrt(m-2)]
  coefs_DiD[, CI_upper_corrected:=coefficient_DiD + 1.96 * standard_error_DiD  * sqrt(nnss-2)/sqrt(m-2)]
  coefs_DiD[, m:=ifelse(coefficient_DiD < 0, "", m)]


  
  l=ggplot(data = coefs_DiD, aes(x=factor(year), y=coefficient_DiD, group=1))+
    geom_errorbar(aes(ymin=CI_lower_corrected , ymax=CI_upper_corrected), width=.1) +
    geom_line() +
    geom_point() +
    geom_text(aes(label=m),vjust=-1)+
    theme_bw()+
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle(paste("change in dry season discharge\nwithout lagged discharge", "\nN= ", nnss,sep = " "))
  return(l)
}

c21=FN_coefficients_DiD_annual_dry_nobs(2008)


FN_coefficients_DiD_annual_lag_dry_nobs     <- function(year_pre) {
  dt=copy(data_reg_copy_daily)
  dt=dt[dry_dummy==1]
  coefs_DiD=data.table()
  for (i in year_pre:2015) {
    dt_1=rbind(dt[year< year_pre], dt[year== i])
    dt_1[, year_treat:=ifelse(year==i, 1, 0)]
    dt_1=dt_1[, treatment:=ifelse(River=="Trinidad" | River=="Ciri grande", 1, 0)]
    
    DiD_annual = lm(tot_discharge ~ treatment + year_treat + treatment:year_treat + total_rain_day + lag.rain_day + day_of_season
                    + lag.discharge# + factor(year) 
                    , data = dt_1)
    coefficient_DiD = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),1]
    standard_error_DiD  = summary(DiD_annual)$coefficients[nrow(summary(DiD_annual)$coefficients),2]
    dt_2=data.table(year=i, coefficient_DiD, standard_error_DiD)
    coefs_DiD=rbind(coefs_DiD, dt_2)
  }

  coefs_DiD[, CI_lower:=coefficient_DiD - 1.96 * standard_error_DiD]
  coefs_DiD[, CI_upper:=coefficient_DiD + 1.96 * standard_error_DiD]
  nnss=nobs(DiD_annual)
  
  coefs_DiD[, m:= ceiling(((1.96 * standard_error_DiD) * sqrt(nnss-2)/coefficient_DiD)^2) + 2]
  coefs_DiD[, CI_lower_corrected:=coefficient_DiD - 1.96 * standard_error_DiD  * sqrt(nnss-2)/sqrt(m-2)]
  coefs_DiD[, CI_upper_corrected:=coefficient_DiD + 1.96 * standard_error_DiD  * sqrt(nnss-2)/sqrt(m-2)]
  coefs_DiD[, m:=ifelse(coefficient_DiD < 0, "", m)]

  
  l=ggplot(data = coefs_DiD, aes(x=factor(year), y=coefficient_DiD, group=1))+
    geom_errorbar(aes(ymin=CI_lower_corrected , ymax=CI_upper_corrected), width=.1) +
    geom_line() +
    geom_point() +
    geom_text(aes(label=m),vjust=-1)+
    theme_bw()+
    xlab("month")+
    ylab("Diff in Diff Coefficient")+
    ggtitle(paste("change in dry season discharge\nwith lagged discharge", "\nN= ", nnss,sep = " "))
  return(l)
}

d21=FN_coefficients_DiD_annual_lag_dry_nobs(2008)




```
# Introduction

We study the provision of hydrological services from agroforestry programs in the Panama Canal Watershed.
Most studies of the program evaluation of PES programs have focused on changes in forest cover as a proxy for the hydrological ecosystem services ( [Borner et al, 2017](http://www.sciencedirect.com/science/article/pii/S0305750X17300827#b0225)). Here, we directly focus on the ecosystem services in question, i.e. river discharge during dry and wet seasons (and potentially sediment load) for the Panama Canal Watershed. For hydrological services, it is important to study the changes at the policy relevant scale, i.e. watershed scale. 


[Alix-Garcia et al. (2012)](http://le.uwpress.org/content/88/4/613.refs) studied the impact of PES program in Mexico which aimed at providing hydrological services through forest conservation. They used applicant pool to create the counterfactual, i.e. those who got the payment vs those who didn't. They found that deforestation rates were 50% lower in enrolled parcels, but that deforestation rates were generally low, which suggested that potential additionality was limited to begin with.

<!-- The evaluated outcomes are often proxies of actual environmental services, such as forest cover, through which programs aim at achieving additional service provision (e.g., carbon sequestration). --> 


When Canal operations were transferred to Panamanian government authorities in 1999, the ACP assumed
responsibility for conserving water and land resources in the Canal watershed. Despite having developed a
watershed land use plan, changes in land uses might eventually jeopardize the availability of water resources
and increase sedimentation within the canal. To address this situation, since 2006 the ACP has implemented
an Environmental Economic Incentive Program (PIEA in Spanish) designed to promote biodiversity and
forestry restoration and protection. Building on this experience, the pilot project will aim to restore about
10,000 hectares of degraded land ( [USAID](https://www.land-links.org/wp-content/uploads/2016/09/USAID_Land_Tenure_TGCC_Panama_Assessment_En.pdf))

Four type of programs were considered in the PIEA. The goals of the four programs are as follows:

+ Agroforestry: Ensure food security through the promotion of crops such as rice, beans, and corn; promote income opportunities from sale of cash crops such as coffee and pineapple; and create economic activity and entrepreneurship.
+ Commercial Reforestation: Planting and harvesting commercially viable tree species for sale.
+ Conservation Reforestation: Planting native tree and plant species for conservation and ecosystem benefits.
+ Silvopasture: Improve cattle farms while conserving natural resources; includes construction of river fords, drinking areas for cattle, living fences, and other improvements.


# Study Area and Data

Sources of data:

+ PIEA parcels
+ hourly rainfall 2004 to 2015
+ daily discharge from hydrology yearbook
+ land cover for 2003, 2008 and 2012 from the ACP
+ start of the dry season date from the ACP
+ PCW watersheds

There 3232 ha in total enrolled in PIEA program. This is 2.7% of total convertible lands in the watershed and 3.6% of private convertible lands. Min area is less than 1 hectare and max is 534 hectares. Ciri Grande and Trinidad have some of the largest enrollments among the watersheds. Most of the land is all allocated to agoroforestry and silvopastoral uses. More than 87% of the commercial reforestation is in the Quebrada Aguas Claras region east of the canal that we do not have discharge data for. 

### Distribution of PIEA hectares across the watershed 

We can see that most of the changes have taken place in the western side of the watershed.

Note that we do not have discharge data for all the watersheds that include hectares enrolled in the PIEA program, so even though some catchments have had significant participation (area-wise), we do not observe changes of discharge in those catchments. Same is valid for control catchments.

```{r, echo=FALSE, warning=FALSE}
ggplot(fills.df) + 
  aes(x=long,y=lat, group=group) +
  geom_polygon(fill= NA) +
  geom_path(color="black") +
  geom_polygon(data = pills.df, aes(x=long,y=lat, group=group), fill="red") +
  geom_path(data = pills.df, aes(x=long,y=lat, group=group), color="red") +
  coord_equal(ratio=1) +
  labs(x="", y="") +
  # scale_fill_gradient(name = "Change in Well Yield",low = "#ff4444", high = "#ffffcc", 
  #                     space = "Lab", na.value = "grey50",
  #                     guide = "colourbar")+
  #  scale_fill_brewer("Utah Ecoregion")+
  #  labs(title="Change in well capacity in Nebraska and Kansas portion of High Plains Aquifer")+
  theme(
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(), 
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank(),
    panel.background = element_rect(fill='white')
  )


```

The number of hectares enrolled is at least comparable to the study by [Alix-Garcia et al. (2012)](http://le.uwpress.org/content/88/4/613.refs).


### Changes in land use covers from 2003 to 2012

Figures below show changes in forested and non-forested land covers across watersheds. Forest cover includes, mature forest, secondary forest, and plantations, while non-forest land includes pasture, crops, scrub, canal grass, towns, and barren soil that potentially have larger rainy season discharge and smaller sponge effect. 
2008 can be taken as the baseline for the project, so if we trust the land cover maps, 2003 to 2008 show the pre-treatment changes in land use in each of the watersheds.

We can see that the eastern watersheds except Chagres have lost forest cover, while western catchments have gained forest cover. Cano Quebrado has had small changes in forest cover. 
The increase in non-forest land has also been increasing in the eastern catchments. Cano Quebrado has also experienced increase in non-forest land which is mainly towns and crop lands. In total, Ciri Grande and Trinidad are the only catchments that have gained forest land while the other catchments have lost forest land cover. Using only PIEA hectares and taking Trinidad and Ciri Grande as treatment and others as control should provide us with an upper bound on the effect of land use changes on ecosystems of interest.

### <span style="color:red"> The last figure is double counting </span>


```{r, echo=FALSE, warning=FALSE, fig.height=11}
# grid_arrange_shared_legend(lu_fig1, lu_fig2, lu_fig3)
multiplot(lu_fig1, lu_fig2, lu_fig3, cols = 1)

# <span style="color:red"> Provide number of hectares in each watershed. </span>

```

### Hectares in PIEA

```{r, results='asis', echo=FALSE}
stargazer(summary_PIEA, type = "html", digits = 1, summary = F, rownames = FALSE)

```

### Summary Statistics

Working on it (somehow showing summary stats by group is not easy in rmarkdown!)


# Results

## Changes in daily discharge before and after treatment

Figures below show the change in mean daily discharge from before 2008 to after 2012 for each catchment in cubic meters. The treatment year is assumed to be 2008 since the PIEA program went into effect (approximately) around 2008. Before 2008 and after 2012 on the graphs simply means that we are comparing 2004-2007 as pre-treatment and 2012-2015 as post-treatment years. These graphs show the changes in for each catchment aggregated by the month.


The first three figures show the changes in daily discharge on the west side of the canal. What these figures show is the distribution of difference in mean of daily discharge before 2008 and after 2012 in black and expected increase in discharge under 20% ESE in red for the dry season. The red bars basically show:

$$
\frac{hectares\;\; in\;\; PIEA}{total\;\;hectares\;\;in\;\;catchment} \times baseline\;\;daily\;\;discharge \times 20\%
$$
in the pre-treatment period (before 2008). The variation comes from the variation of daily discharge at each month. We can see that the expected increase in daily discharge is small compared to variations of change in daily discharge (which is $\frac{\sigma_{pre}^2}{n_{pre}} + \frac{\sigma_{post}^2}{n_{post}}$ ). These red bars are particularly interesting because I had imagined that they would be higher than were they are, but these bars are themselves very close to zero relative to the variations of the daily discharge. 

Ciri Grande and Trinidad had the most intensive PIEA participation hectares, while Cano Quebrado almost did not have any program related land use change. Cano Quebrado is perhaps the best control for these two catchments as it is in the western side of the canal. A quick look at the figures suggest small treatment effects if any. Note that these graphs are showing the averages and there are no controls.


```{r, echo=FALSE, warning=FALSE}
## West Side
multiplot(a1, a2, a3, cols=2)
```

Next four figures show the changes in daily discharge on the east side of the canal. Chagres has experienced an increase in net forest cover and this maybe the reason behind an increase in daily discharge. It's difficult to explain the other changes. 

```{r, echo=FALSE, warning=FALSE}
## East Side
multiplot(a4, a5, a6, a7, cols=2)

```

## Diff-in-Diff estimates:

### Monthly estimates:

Next, we consider the diff-in-diff estimates. We consider Trinidad and Ciri Grande as treatment and other catchments as control. We also control for faily and lagged daily rain and number of days since the start of the dry season. The unit of observation is catchment-day.

$$total~discharge = \beta_0 ~ treatment + \beta_1 ~ years ~ treated + \beta_3 ~ treatment \times year ~ treated + \\
\beta_4 ~ daily ~ rain + \beta_5 ~ lagged ~ daily ~ rain + \beta_6 ~   day ~ of ~ dry ~ (or ~ wet) ~ season + year ~ FE + \epsilon$$

Figures below show $\beta_3$ for each month. The standard errors have been boosted to consider for the fact that we picked each month as a sample. However, they have not been clustered.

Add the red lines from data_pre here too.

```{r, echo=FALSE, warning=FALSE}
multiplot(b1, b2, b3, b4, cols=2)

```


### Including lagged discharge due to autocorrelation:

```{r, echo=FALSE, warning=FALSE}
multiplot(b5, b6, b7, b8, cols=2)

```

### Changing treatment year to 2010

```{r, echo=FALSE, warning=FALSE}
multiplot(b15, b16, b17, b18, cols=2)

```

The prefered figure to look at in all of the three sets of figures above is before 2008 and after 2012 as it includes more observations (after 2013 only includes two years of post-treatment and before 2007 inlcudes only two years of pre-treatment). Overall, the coefficients seem robust across specifications. These estimates do not completely reject the idea of existence of the sponge effect, especially given that the expected effects were very small. They suggest that in dry months across all sepcifications we see positive but very imprecisely estimated effects from land use change. In the wet season, it is more difficult to see negative effecets.


### Changes in year-to-year dry season discharge over time

Next, we look at the changes in dry seaosn and wet discharge across years. We set the baseline (pre-treatment) at 2004-2007 and compare dry season discharge to the baseline. The results suggest that we cannot observe a pttern over time in discharge. We can also see that 2013 shows an increase in wet season discharge which is perhaps driving the wet season estimates in the figures above. 


```{r, echo=FALSE, warning=FALSE}
multiplot(c1, c2, d1, d2, cols=2)

```

## Power Calculations

How large shuold n be to provide us with estimates that are different from zero but not different from 20% ESE?

A simple power calculation would be to increase n or find $m$ such that when we multiply se by $\frac{\sqrt(n-2)}{\sqrt(m-2)}$, the confidence interval does not inclde zero. The figures below show the number of observations required for positive coefficients of change in daily discharge to be different from zero at 5% (Eli and I have also talked about testing what is the probability that we are wrong for the negative coefficients and that they are actually positive. However, in the new version most of the coefficients are positive. So I did not pursue that yet.)

To put things in perspective, 4321 observations required is around 14 *more* years of data for the month of February and 6,224 observations for dry season in 2015 is 0.3 more years of data.

```{r, echo=FALSE, warning=FALSE, fig.height=8}
# grid_arrange_shared_legend(lu_fig1, lu_fig2, lu_fig3)
multiplot(b21, c21, b22, d21, cols = 2)

# <span style="color:red"> Provide number of hectares in each watershed. </span>

```

## Next Steps

### <span style="color:red"> Other qustions we can ask/ pieces we can add: </span>


+ Did PIEA result in land use changes? compare land use for PIEA polygons before and after treatment. Also we can do matching since we have the actual parcels in the Ciri Grande and Trinidad catchments, but this is more of an additionality story.
+ Are there other deforestation activity that canceled out the effect of agroforestry programs? based on the land cover data it looks like it's actually the other way around
+ What are the characteristics of parcels that participated in the program compared to other parcels? 
+ Compare changes from 2004 to 2008 to changes from 2008 to 2013 
+ explore sediment volume as the other dependent variable
+ Annual forest cover loss between 2000 and 2016 is available from [Forest Watch](http://www.globalforestwatch.org/map/10/8.99/-79.58/PAN/grayscale/forest2000,loss/663?tab=analysis-tab&begin=2001-01-01&end=2017-01-01&threshold=30&dont_analyze=true). Do we pursue a panel analysis?






